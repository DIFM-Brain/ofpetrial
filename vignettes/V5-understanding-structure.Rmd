---
title: "Understanding the structure of objects"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Understanding the structure of objects}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  message = FALSE,
  warning = FALSE,
  comment = "#>"
)
```

The `ofpetrial` package does not offer any package-specific object classes. Rather, it uses the `tibble` (`tbl_df`, `tbl`, `data.frame`) object from the `tibble` package extensively. 

Let's first create a plot information using `prep_plot()`.

```{r}
library(ofpetrial)

seed_plot_info <-
  prep_plot(
    input_name = "seed",
    unit_system = "imperial",
    machine_width = 60,
    section_num = 24,
    harvester_width = 30,
    plot_width = 30
  )

#--- check the class ---#
class(seed_plot_info)

#--- check the structure ---#
dplyr::glimpse(seed_plot_info)
```

It can be easily mutated since it is a `tibble` (and also a `data.frame`). For example, you can change the plot width like below.

```{r}
#--- replace ---#
seed_plot_info$plot_width <- 60

#--- check ---#
seed_plot_info$plot_width
```

Let's now create experiment plots using `make_exp_plots()` for a two-input case.

```{r}
#--- create plot information for another input ---#
n_plot_info <-
  prep_plot(
    input_name = "NH3",
    unit_system = "imperial",
    machine_width = 45,
    section_num = 1,
    harvester_width = 30,
    plot_width = 45
  )

#--- create experiment plots ---#
exp_data <-
  make_exp_plots(
    input_plot_info = list(seed_plot_info, n_plot_info),
    boundary_data = system.file("extdata", "boundary-simple1.shp", package = "ofpetrial"),
    abline_data = system.file("extdata", "ab-line-simple1.shp", package = "ofpetrial"),
    abline_type = "free"
  )

#--- glimpse ---#
dplyr::glimpse(exp_data)
```

As you can see from below, there are four columns of type `list`: `headland`, `exp_plots`, `ab_lines`, `harvest_ab_lines`. They are called list-columns, which are just like a regular variable except it is a list. List-columns are extremely handy when you would like to store things like vectors or `data.frame` as a cell value in a dataset (`exp_data` here). 

Let's take a look at `exp_plots` variable of `exp_data`. You can access them just like you access a regular variable using $ (or any other methods to pull a variable from a `tibble`).

```{r}
exp_data$exp_plots
```

As you can see, it is a list of two `sf` objects of experiment plots. Since, it is a list, you can access the `sf` itself like this.

```{r}
exp_data$exp_plots[[1]]
```

Let's now assign rates to the experiemnt plots (`exp_plots`) in `exp_data`.

```{r}
#--- prepare rate information ---#
seed_rate_info <-
  prep_rate(
    plot_info = seed_plot_info,
    gc_rate = 32000,
    unit = "seed",
    min_rate = 16000,
    max_rate = 40000,
    num_rates = 5,
    design_type = "jcls"
  )

n_rate_info <-
  prep_rate(
    plot_info = n_plot_info,
    gc_rate = 180,
    unit = "lb",
    rates = c(100, 140, 180, 220, 260),
    design_type = "ls",
    rank_seq_ws = c(5, 4, 3, 2, 1)
  )

#--- assign rates ---#
td <- assign_rates(exp_data, rate_info = list(seed_rate_info, n_rate_info))
```

As you can see, `td` has a very similar structure and sets of variables (e.g., `input_name` and `exp_plots` were inherited from `exp_data`). This is not surprising because we just assigned rates to the experiment plots with `assign_rates()`.

```{r}
dplyr::glimpse(td)
```

A trial design (experiment plots with rates assigned) has a name of `trial_design`, which is also a list-column.

```{r}
#--- check the class ---#
class(td$trial_design)

td$trial_design
```

Since the individual trial designs are just `sf`, you can of course wrangle them direclty if you would like to. 

```{r}
#--- get the trial design sf for the first input ---#
(
td_for_input_1 <- td$trial_design[[1]]
)

#--- change the rates to all 0 ---#
(
td_for_input_1 <- dplyr::mutate(td_for_input_1, rate = 0)
)
```

Note that this does not alter `tiral_design` in `td`. So, if you want this to be reflected in `td`, you need to assign it back. The `change_rates()` function is designed to work directly on `td` to avoid this tedious procedure when modifying rates (see [this vignette](https://difm-brain.github.io/ofpetrial/articles/V3-change-rates-manually.html)). If you really want to or must work directly on the `trial_design` part, we just showed that it is definitely possible. 

Many other functions return a tibble with list-columns. For example, `check_alignment()` checks whether the trial design would have a mixed treatment problem.

```{r}
check <- check_alignment(exp_data)

dplyr::glimpse(check)
```

As you can see, its output has four list-columns and there are three different types of objects stored in them.

+ `overlap_data`: list of `data.frame`s
+ `harvester_path`: list of `sf`s
+ `g_path_alignment` and `g_overlap`: list of `ggplot`s

Let's access the second of `harvester_path`.
```{r}
check$harvester_path[[2]]
```





